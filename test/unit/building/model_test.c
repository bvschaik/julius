#include "loki/loki.h"
#include "building/model.h"

#include <stdint.h>

int string_length(const uint8_t *str)
{
    int length = 0;
    while (*str) {
        length++;
        str++;
    }
    return length;
}

CREATE_MOCK3(int, io_read_file_into_buffer, const char*, void*, int)
CREATE_MOCK1(int, string_to_int, const char *)
CREATE_VMOCK3(debug_log, const char*, const char*, int)

INIT_MOCKS(
    INIT_MOCK(io_read_file_into_buffer)
    INIT_MOCK(string_to_int)
    INIT_MOCK(debug_log)
)

char *data_to_read = 0;

int c3_model(const char *filename, void *buffer, int size)
{
    if (strcmp(filename, "c3_model.txt") == 0) {
        if (data_to_read) {
            char *data = (char*) buffer;
            strcpy(data, data_to_read);
        }
        return 1;
    }
    return 0;
}

int num_calls_to_string_to_int;
int dummy_string_to_int(const char *input)
{
    num_calls_to_string_to_int++;
    return 1;
}

void test_model_load_no_file()
{
    when_io_read_file_into_buffer_dynamic(c3_model)->then_return = 0;
    
    assert_false(model_load());
}

void test_model_load_invalid_file()
{
    data_to_read = "ALL HOUSES";

    when_io_read_file_into_buffer_dynamic(c3_model)->then_return = (int) strlen(data_to_read);
    
    assert_false(model_load());
}

void test_model_load_too_small_file()
{
    data_to_read = "ALL BUILDINGS"
        "{,0,0,0,0,0,0,0,0,} {,1,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,4,0,0,0,0,0,0,0,} {,12,0,0,0,0,0,0,0,} {,30,0,0,0,0,0,0,0,} {,8,-2,1,1,2,0,0,0,} {,2,0,0,0,0,0,0,0,}"
        "ALL HOUSES"
        "{,-99,-10,0,0,0,0,0,0,0,0,0,0,0,0,0,3,25,5,5,1,,,2.5,,,,,,";

    when_io_read_file_into_buffer_dynamic(c3_model)->then_return = (int) strlen(data_to_read);
    
    assert_false(model_load());
}

void test_model_load_actual_file()
{
    data_to_read = "ALL BUILDINGS"
        "{,0,0,0,0,0,0,0,0,} {,1,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,4,0,0,0,0,0,0,0,} {,12,0,0,0,0,0,0,0,} {,30,0,0,0,0,0,0,0,} {,8,-2,1,1,2,0,0,0,} {,2,0,0,0,0,0,0,0,}"
        "{,10,-3,1,1,3,0,0,0,} {,0,-3,1,1,3,0,0,0,} {,0,-2,1,1,2,0,0,0,} {,0,-2,1,1,2,0,0,0,} {,0,-2,1,1,2,0,0,0,} {,0,-2,1,1,2,0,0,0,} {,0,-1,1,1,1,0,0,0,} {,0,-1,1,1,1,0,0,0,} {,0,0,1,1,1,0,0,0,} {,0,0,1,1,1,0,0,0,}"
        "{,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,1,2,-1,2,0,0,0,} {,0,1,2,-1,2,0,0,0,} {,0,2,2,-2,2,0,0,0,} {,0,2,2,-2,2,0,0,0,} {,0,3,2,-1,6,0,0,0,} {,0,3,2,-1,6,0,0,0,} {,0,4,2,-1,6,0,0,0,} {,0,4,2,-1,6,0,0,0,}"
        "{,100,4,1,-1,4,12,0,0,}, {,50,2,1,-1,2,8,0,0,}, {,2500,-3,1,1,3,150,0,0,}, {,500,-3,1,1,3,25,0,0,}, {,75,-3,1,1,3,8,0,0,}, {,75,-3,1,1,3,8,0,0,}, {,50,2,1,-1,2,5,0,0,}, {,75,-3,1,1,3,10,0,0,}, {,15,4,1,-2,2,0,0,0,}, {,12,3,1,-1,3,0,0,0,},"
        "{,1000,-20,2,2,8,16,0,0,}, {,12,3,1,-1,3,0,0,0,}, {,60,10,1,-2,4,0,0,0,}, {,150,14,2,-2,5,0,0,0,}, {,1000,-20,2,2,8,16,0,0,} {,1000,-20,2,2,8,16,0,0,}, {,30,0,0,0,0,5,0,0,}, {,300,-1,2,1,2,30,0,0,}, {,50,4,1,-1,4,10,0,0,}, {,25,2,1,-1,2,2,0,0,},"
        "{,0,0,0,0,0,0,0,0,}, {,50,-2,1,1,2,10,0,0,}, {,100,4,1,1,4,30,0,0,}, {,75,4,1,-1,4,20,0,0,}, {,0,0,0,0,0,0,0,0,}, {,30,-2,1,1,2,6,0,0,}, {,0,18,2,3,5,0,0,0,}, {,250,-20,2,2,8,16,0,0,} {,100,-4,1,1,3,3,0,0,}, {,150,-8,1,2,3,6,0,0,},"
        "{,50,4,2,-1,6,2,0,0,}, {,50,4,2,-1,6,2,0,0,}, {,50,4,2,-1,6,2,0,0,} {,50,4,2,-1,6,2,0,0,} {,50,4,2,-1,6,2,0,0,} {,150,8,2,-1,8,5,0,0,} {,150,8,2,-1,8,5,0,0,} {,150,8,2,-1,8,5,0,0,} {,150,8,2,-1,8,5,0,0,} {,150,8,2,-1,8,5,0,0,}"
        "{,40,-2,1,1,6,5,0,0,} {,100,-4,1,2,2,6,0,0,} {,70,-5,2,2,3,6,0,0,} {,0,0,0,0,0,0,0,0,} {,100,-8,2,2,3,10,0,0,} {,100,-8,2,2,3,12,0,0,} {,60,-8,2,2,3,6,0,0,} {,150,12,2,-2,3,0,0,0,} {,400,20,2,-3,4,0,0,0,} {,700,28,2,-4,5,0,0,0,}"
        "{,100,-3,1,1,2,20,0,0,} {,30,0,1,1,1,5,0,0,} {,40,0,0,0,0,0,0,0,} {,100,0,0,0,0,0,0,0,} {,250,8,2,-2,2,20,0,0,} {,400,8,2,-1,8,30,0,0,} {,75,3,2,-1,2,6,0,0,} {,125,3,2,-1,2,8,0,0,} {,50,0,0,0,0,0,0,0,} {,50,0,0,0,0,0,0,0,}"
        "{,80,-6,1,2,3,0,0,0,} {,15,0,0,0,0,4,0,0,} {,5,-1,1,2,1,1,0,0,} {,0,0,0,0,0,0,0,0,} {,1000,-3,1,1,3,20,0,0,} {,150,-6,1,1,3,10,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,200,8,2,-1,6,0,0,0,} {,0,-1,1,1,2,0,0,0,}"
        "{,40,-2,1,1,2,10,0,0,} {,40,-2,1,1,2,10,0,0,} {,40,2,1,1,2,10,0,0,} {,40,2,1,1,2,10,0,0,} {,40,2,1,1,2,10,0,0,} {,40,-2,1,1,2,10,0,0,} {,50,-6,1,1,4,10,0,0,} {,50,-6,1,1,4,10,0,0,} {,40,-4,1,1,3,10,0,0,} {,40,-3,1,1,2,10,0,0,}"
        "{,45,-1,1,1,1,10,0,0,} {,50,-4,1,1,2,10,0,0,} {,50,-4,1,1,2,10,0,0,} {,40,-4,1,1,2,10,0,0,} {,40,-4,1,1,2,10,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,}"
        "{,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,} {,0,0,0,0,0,0,0,0,}"
        "ALL HOUSES"
        "{,-99,-10,0,0,0,0,0,0,0,0,0,0,0,0,0,3,25,5,5,1"
        "{,-12,-5,0,1,0,0,0,0,0,0,0,0,0,0,0,3,25,10,7,1"
        "{,-7,0,0,1,0,0,1,0,0,0,1,0,0,0,0,3,25,15,9,1"
        "{,-2,4,0,1,1,0,1,0,0,0,1,0,0,0,0,3,25,20,11,1"
        "{,2,8,0,2,1,0,1,0,0,0,1,0,0,0,0,3,22,25,13,2"
        "{,6,12,10,2,1,0,1,0,0,0,1,0,0,0,0,3,22,30,15,2"
        "{,10,16,10,2,1,1,1,0,0,0,1,0,0,0,0,2,17,35,17,2"
        "{,14,20,10,2,1,1,1,0,1,0,1,1,0,0,0,2,17,45,19,2"
        "{,18,25,25,2,1,1,1,0,1,0,1,1,0,0,0,2,17,50,19,3"
        "{,22,32,25,2,1,1,1,0,1,1,1,1,0,1,0,2,17,58,20,3"
        "{,29,40,25,2,1,2,1,1,1,1,1,1,1,1,0,2,12,65,84,3"
        "{,37,48,35,2,1,2,1,1,1,1,2,1,1,1,0,2,12,80,84,4"
        "{,45,53,35,2,2,2,1,1,1,1,2,1,1,1,1,1,8,150,40,9"
        "{,50,58,40,2,2,2,1,1,1,2,2,1,1,1,1,1,8,180,42,10"
        "{,55,63,45,2,2,3,1,1,1,2,2,1,1,1,1,1,8,400,90,11"
        "{,60,68,50,2,3,3,1,1,1,2,3,1,1,1,1,1,8,600,100,11"
        "{,65,74,55,2,3,3,1,1,1,2,3,1,1,1,2,1,5,700,106,12"
        "{,70,80,60,2,4,3,1,1,1,2,3,1,1,1,2,1,5,900,112,12"
        "{,76,90,70,2,4,3,1,1,1,2,3,1,1,1,2,1,5,1500,190,15"
        "{,85,100,80,2,4,3,1,1,1,2,3,1,1,1,2,1,5,1750,200,16";

    num_calls_to_string_to_int = 0;
    when_string_to_int_dynamic(dummy_string_to_int)->then_return = 123;
    when_io_read_file_into_buffer_dynamic(c3_model)->then_return = (int) strlen(data_to_read);
    
    int result = model_load();
    assert_true(result);
    assert_eq(1440, num_calls_to_string_to_int); // 130 * 6+2 + 20 * 18+2
    
    // all ints are filled with 123, check a few random ones
    assert_eq(123, model_get_building(BUILDING_ACADEMY)->cost);
    assert_eq(123, model_get_house(HOUSE_LARGE_HOVEL)->max_people);
}

RUN_TESTS(building.model,
    ADD_TEST(test_model_load_no_file)
    ADD_TEST(test_model_load_invalid_file)
    ADD_TEST(test_model_load_too_small_file)
    ADD_TEST(test_model_load_actual_file)
)
